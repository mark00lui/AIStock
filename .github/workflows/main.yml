# .github/workflows/daily_report_generator.yml
name: Generate and Deploy Daily Report

on:
  # æ¯å¤©å°ç£æ™‚é–“æ—©ä¸Š 8 é»åŸ·è¡Œ (00:00 UTC)
  # æ‚¨å¯ä»¥é€é crontab.guru ç¶²ç«™ç”¢ç”Ÿè‡ªå·±æƒ³è¦çš„æ™‚é–“
  schedule:
    # å°ç£æ™‚é–“ä¸‹åˆ 5:00 (UTC 9:00ï¼Œç•¶å¤©æ—©ä¸Š 9 é»)
    - cron: '0 9 * * *'
    # å°ç£æ™‚é–“æ—©ä¸Š 5:00 (UTC 21:00ï¼Œå‰ä¸€å¤©æ™šä¸Š 9 é»)
    - cron: '0 21 * * *'
  # å¢åŠ æ‰‹å‹•è§¸ç™¼é¸é …ï¼Œæ–¹ä¾¿æ¸¬è©¦
  workflow_dispatch:

jobs:
  build-and-deploy:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      # æ­¥é©Ÿ 1: å–å¾—æ‚¨çš„å°ˆæ¡ˆåŸå§‹ç¢¼
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.5' # æŒ‡å®šæ‚¨éœ€è¦çš„ Python ç‰ˆæœ¬

      # æ­¥é©Ÿ 3: å®‰è£å°ˆæ¡ˆæ‰€éœ€çš„å¥—ä»¶
      # æˆ‘çœ‹åˆ°æ‚¨çš„å°ˆæ¡ˆä¸­æœ‰ requirements.txtï¼Œé€™å€‹æŒ‡ä»¤æœƒè‡ªå‹•å®‰è£è£¡é¢æ‰€æœ‰çš„å¥—ä»¶
      - name: Install dependencies ğŸ“¦
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # æ­¥é©Ÿ 4: åŸ·è¡Œæ‚¨çš„ Python ä¸»ç¨‹å¼
      # *** è«‹å°‡ Main.py æ›æˆæ‚¨å°ˆæ¡ˆçš„å¯¦éš›å•Ÿå‹•æª”å ***
      - name: Run script to generate report ğŸš€
        run: |
          python main.py \
            [é‡å€‰è‚¡-AIåŠSOC] NVDA AMD MU TSM PLTR QCOM 2454.TW 2330.TW 2308.TW 6805.TW \
            [é‡å€‰è‚¡-AIé›²] AMZN MSFT GOOGL META BABA BIDU NBIS CRWV \
            [é‡å€‰è‚¡-ç¶²è·¯å®‰å…¨] CSCO PANW FTNT CRWD \
            [Q4ä¸Šæ¼²-ä»£å·¥] SMCI 2317.TW 6669.TW 3231.TW 2382.TW 3706.TW 2376.TW 2357.TW \
            [æŠ±5å¹´-ASIC] AVGO MRVL 3661.TW  \
            [æŠ±5å¹´-ç‰¹æ–¯æ‹‰æ©Ÿå™¨äººåŠé£›è¡Œå™¨] TSLA RKLB 3019.TW 6215.TW 4571.TW 3362.TW 2359.TW \
            [é«˜å±éšª-çŸ½å…‰å­] 2345.TW 6223.TW 3081.TW 3363.TW 3450.TW 4979.TW 3163.TW \
            [é•·æœŸä¸æŒ¯-åŠå°é«”ä»£ç†å•†] 8299.TW 8112.TW \
            [æ…¢æˆé•·-è˜‹æ¦‚è‚¡] AAPL 3008.TW 2392.TW 6197.TW \
            [é«˜åº¦ä¸å®šæ€§-å‚³çµ±é†«ç™‚åŠAIé†«ç™‚] UNH TEM HIMS UNCY \
            [é«˜åº¦ä¸å®šæ€§-èƒ½æºè‚¡] LEU CVX VST SMR OKLO \
            [å¹´åˆè²·å…­æœˆè³£-èˆªæµ·ç‹] 2603.TW 2615.TW \
            [é‡‘èåŠç©©å®šå¹£ç­‰AIé‡‘è] BAC JPM V MA SOFI COIN CRCL 2881.TW 2882.TW 2891.TW 3988.HK MSTR SBET BMNR MARA \
            --save-daily-report \
            --GEMINI-API ${{ secrets.GEMINI_API_KEY }}

      # æ­¥é©Ÿ 5: æº–å‚™ç™¼ä½ˆå…§å®¹
      - name: Prepare deployment files ğŸ“‚
        run: |
          # å°‹æ‰¾ä»Šå¤©ç”¢ç”Ÿçš„å ±å‘Šæª”æ¡ˆ
          report_file=$(find . -maxdepth 1 -name "*_report.html" -print -quit)
          
          if [ -z "$report_file" ]; then
            echo "::error::Report file not found!"
            exit 1
          fi
          
          echo "Found report: $report_file"
          
          # å»ºç«‹ä¸€å€‹è‡¨æ™‚çš„ç™¼ä½ˆç›®éŒ„
          mkdir -p deploy
          
          # å°‡æœ€æ–°çš„å ±å‘Šè¤‡è£½ä¸€ä»½ä¸¦å‘½åç‚º latest_report.html
          cp "$report_file" deploy/latest_report.html
          
          # å»ºç«‹ reports è³‡æ–™å¤¾ä¸¦å°‡åŸå§‹å ±å‘Šç§»å…¥
          mkdir -p deploy/reports
          mv "$report_file" deploy/reports/

      # æ­¥é©Ÿ 6: å°‡ç”¢ç”Ÿçš„æª”æ¡ˆç™¼ä½ˆåˆ° gh-pages åˆ†æ”¯
      - name: Deploy to GitHub Pages ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # æŒ‡å®šè¦ç™¼ä½ˆçš„æ˜¯æˆ‘å€‘å‰›å‰›å»ºç«‹çš„ deploy è³‡æ–™å¤¾
          publish_dir: ./deploy
          # æŒçºŒå°‡æ›´æ–°æ¨é€åˆ° gh-pages åˆ†æ”¯
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Docs: Deploy daily report"
