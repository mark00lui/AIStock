# .github/workflows/daily_report_generator.yml
name: Generate and Deploy Daily Report

on:
  # æ¯å¤©å°ç£æ™‚é–“æ—©ä¸Š 8 é»åŸ·è¡Œ (00:00 UTC)
  # æ‚¨å¯ä»¥é€é crontab.guru ç¶²ç«™ç”¢ç”Ÿè‡ªå·±æƒ³è¦çš„æ™‚é–“
  schedule:
    - cron: '0 0 * * *'
  # å¢åŠ æ‰‹å‹•è§¸ç™¼é¸é …ï¼Œæ–¹ä¾¿æ¸¬è©¦
  workflow_dispatch:

jobs:
  build-and-deploy:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      # æ­¥é©Ÿ 1: å–å¾—æ‚¨çš„å°ˆæ¡ˆåŸå§‹ç¢¼
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.5' # æŒ‡å®šæ‚¨éœ€è¦çš„ Python ç‰ˆæœ¬

      # æ­¥é©Ÿ 3: å®‰è£å°ˆæ¡ˆæ‰€éœ€çš„å¥—ä»¶
      # æˆ‘çœ‹åˆ°æ‚¨çš„å°ˆæ¡ˆä¸­æœ‰ requirements.txtï¼Œé€™å€‹æŒ‡ä»¤æœƒè‡ªå‹•å®‰è£è£¡é¢æ‰€æœ‰çš„å¥—ä»¶
      - name: Install dependencies ğŸ“¦
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # æ­¥é©Ÿ 4: åŸ·è¡Œæ‚¨çš„ Python ä¸»ç¨‹å¼
      # *** è«‹å°‡ Main.py æ›æˆæ‚¨å°ˆæ¡ˆçš„å¯¦éš›å•Ÿå‹•æª”å ***
      - name: Run script to generate report ğŸš€
        run: |
          python main.py 2330.TW 3019.TW 3008.TW 2382.TW --save-daily-report

      # æ­¥é©Ÿ 5: å°‡å ±å‘Šé‡æ–°å‘½åç‚ºå›ºå®šæª”æ¡ˆåç¨± (é‡è¦!)
      # é€™å€‹æŒ‡ä»¤æœƒæ‰¾åˆ°ä»Šå¤©ç”¢ç”Ÿçš„å ±å‘Šï¼Œä¸¦å°‡å®ƒå‘½åç‚º report.html
      - name: Rename report file ğŸ“
        run: |
          # å°‹æ‰¾ YYYY-MM-DD_report.html æ ¼å¼çš„æª”æ¡ˆ
          report_file=$(find . -maxdepth 1 -name "*_report.html" -print -quit)
          if [ -n "$report_file" ]; then
            mv "$report_file" report.html
            echo "Renamed $report_file to report.html"
          else
            echo "::error::Report file not found!"
            exit 1
          fi

      # æ­¥é©Ÿ 6: å°‡ç”¢ç”Ÿçš„ report.html ç™¼ä½ˆåˆ° gh-pages åˆ†æ”¯
      - name: Deploy to GitHub Pages ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: . # æŒ‡å®šè¦ç™¼ä½ˆçš„ç›®éŒ„ (æ ¹ç›®éŒ„)
          publish_branch: gh-pages # ç™¼ä½ˆåˆ° gh-pages åˆ†æ”¯
          # åªæ¨é€ report.htmlï¼Œé¿å…å…¶ä»–æª”æ¡ˆä¹Ÿè¢«æ¨é€
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          # æŒ‡å®šåªæ¨é€ report.html
          # allow_empty_commit: true
          # keep_files: false
          # cname: example.com # å¦‚æœæ‚¨æœ‰è‡ªè¨‚ç¶²åŸŸ
          # ä¸Šé¢é€™å¹¾è¡Œæ˜¯é€²éšè¨­å®šï¼Œç›®å‰ç”¨ä¸åˆ°
