# .github/workflows/daily_report_generator.yml
name: Generate and Deploy Daily Report

on:
  # 每天台灣時間早上 8 點執行 (00:00 UTC)
  # 您可以透過 crontab.guru 網站產生自己想要的時間
  schedule:
    - cron: '0 0 * * *'
  # 增加手動觸發選項，方便測試
  workflow_dispatch:

jobs:
  build-and-deploy:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      # 步驟 1: 取得您的專案原始碼
      - name: Checkout 🛎️
        uses: actions/checkout@v4

      # 步驟 2: 設定 Python 環境
      - name: Set up Python 🐍
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.5' # 指定您需要的 Python 版本

      # 步驟 3: 安裝專案所需的套件
      # 我看到您的專案中有 requirements.txt，這個指令會自動安裝裡面所有的套件
      - name: Install dependencies 📦
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 步驟 4: 執行您的 Python 主程式
      # *** 請將 Main.py 換成您專案的實際啟動檔名 ***
      - name: Run script to generate report 🚀
        run: |
          python main.py 2330.TW 3019.TW 3008.TW 2382.TW --save-daily-report

      # 步驟 5: 將報告重新命名為固定檔案名稱 (重要!)
      # 這個指令會找到今天產生的報告，並將它命名為 report.html
      - name: Rename report file 📝
        run: |
          # 尋找 YYYY-MM-DD_report.html 格式的檔案
          report_file=$(find . -maxdepth 1 -name "*_report.html" -print -quit)
          if [ -n "$report_file" ]; then
            mv "$report_file" report.html
            echo "Renamed $report_file to report.html"
          else
            echo "::error::Report file not found!"
            exit 1
          fi

      # 步驟 6: 將產生的 report.html 發佈到 gh-pages 分支
      - name: Deploy to GitHub Pages 🚀
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: . # 指定要發佈的目錄 (根目錄)
          publish_branch: gh-pages # 發佈到 gh-pages 分支
          # 只推送 report.html，避免其他檔案也被推送
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          # 指定只推送 report.html
          # allow_empty_commit: true
          # keep_files: false
          # cname: example.com # 如果您有自訂網域
          # 上面這幾行是進階設定，目前用不到
